#!/bin/bash
# Hapus semua VPC di AWS (selain default)

# Ambil semua VPC ID kecuali default
vpcs=$(aws ec2 describe-vpcs --query "Vpcs[?IsDefault==\`false\`].VpcId" --output text)

for vpc in $vpcs; do
  echo "Processing VPC: $vpc"

  # Hapus dependent resources
  echo "  -> Hapus Subnets..."
  aws ec2 describe-subnets --filters "Name=vpc-id,Values=$vpc" --query "Subnets[].SubnetId" --output text | \
    xargs -n1 -r aws ec2 delete-subnet --subnet-id

  echo "  -> Hapus Route Tables..."
  for rtb in $(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$vpc" --query "RouteTables[].RouteTableId" --output text); do
    # Jangan hapus main route table
    main=$(aws ec2 describe-route-tables --route-table-ids $rtb --query "RouteTables[].Associations[].Main" --output text)
    if [ "$main" != "True" ]; then
      aws ec2 delete-route-table --route-table-id $rtb
    fi
  done

  echo "  -> Hapus Internet Gateways..."
  for igw in $(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$vpc" --query "InternetGateways[].InternetGatewayId" --output text); do
    aws ec2 detach-internet-gateway --internet-gateway-id $igw --vpc-id $vpc
    aws ec2 delete-internet-gateway --internet-gateway-id $igw
  done

  echo "  -> Hapus Security Groups..."
  for sg in $(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$vpc" --query "SecurityGroups[?GroupName!='default'].GroupId" --output text); do
    aws ec2 delete-security-group --group-id $sg
  done

  echo "  -> Hapus Network ACLs..."
  for acl in $(aws ec2 describe-network-acls --filters "Name=vpc-id,Values=$vpc" --query "NetworkAcls[?IsDefault==\`false\`].NetworkAclId" --output text); do
    aws ec2 delete-network-acl --network-acl-id $acl
  done

  echo "  -> Hapus VPC Peering (jika ada)..."
  for peer in $(aws ec2 describe-vpc-peering-connections --filters "Name=requester-vpc-info.vpc-id,Values=$vpc" --query "VpcPeeringConnections[].VpcPeeringConnectionId" --output text); do
    aws ec2 delete-vpc-peering-connection --vpc-peering-connection-id $peer
  done

  echo "  -> Terakhir, hapus VPC..."
  aws ec2 delete-vpc --vpc-id $vpc
done

echo "âœ… Semua VPC non-default berhasil dihapus."
