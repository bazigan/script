


# Script hapus IAM User
# Daftar user yang mau DIKECUALIKAN (tidak dihapus)
EXCLUDE_USERS=("amar" "Jingga")

# Ambil semua IAM users
ALL_USERS=$(aws iam list-users --query "Users[].UserName" --output text)

if [ -z "$ALL_USERS" ]; then
    echo "Tidak ada IAM user ditemukan."
    exit 0
fi

echo "Ditemukan IAM Users:"
echo "$ALL_USERS"
echo

# Filter user yang tidak termasuk dalam daftar pengecualian
USERS_TO_DELETE=()
for user in $ALL_USERS; do
    skip=false
    for ex in "${EXCLUDE_USERS[@]}"; do
        if [ "$user" = "$ex" ]; then
            skip=true
            break
        fi
    done
    if [ "$skip" = false ]; then
        USERS_TO_DELETE+=("$user")
    fi
done

# Jika tidak ada yang akan dihapus
if [ ${#USERS_TO_DELETE[@]} -eq 0 ]; then
    echo "Tidak ada user yang akan dihapus."
    exit 0
fi

echo "User yang akan DIHAPUS:"
printf '%s\n' "${USERS_TO_DELETE[@]}"
echo
read -p "Apakah kamu yakin ingin menghapus user di atas? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "âŒ Dibatalkan."
    exit 0
fi

# Hapus satu per satu user (harus kosong dulu: hapus access key, policy, dsb.)
for user in "${USERS_TO_DELETE[@]}"; do
    echo "ðŸ”¹ Memproses user: $user"

    # Hapus access keys
    KEYS=$(aws iam list-access-keys --user-name "$user" --query "AccessKeyMetadata[].AccessKeyId" --output text)
    for key in $KEYS; do
        aws iam delete-access-key --user-name "$user" --access-key-id "$key"
        echo "  - Access key $key dihapus"
    done

    # Hapus inline policies
    POLICIES=$(aws iam list-user-policies --user-name "$user" --query "PolicyNames[]" --output text)
    for pol in $POLICIES; do
        aws iam delete-user-policy --user-name "$user" --policy-name "$pol"
        echo "  - Inline policy $pol dihapus"
    done

    # Hapus managed policies
    ATTACHED=$(aws iam list-attached-user-policies --user-name "$user" --query "AttachedPolicies[].PolicyArn" --output text)
    for arn in $ATTACHED; do
        aws iam detach-user-policy --user-name "$user" --policy-arn "$arn"
        echo "  - Managed policy $arn dilepas"
    done

    # Hapus user dari group
    GROUPS=$(aws iam list-groups-for-user --user-name "$user" --query "Groups[].GroupName" --output text)
    for grp in $GROUPS; do
        aws iam remove-user-from-group --user-name "$user" --group-name "$grp"
        echo "  - Dihapus dari group $grp"
    done

    # Hapus login profile (kalau ada)
    aws iam delete-login-profile --user-name "$user" 2>/dev/null && echo "  - Login profile dihapus"

    # Terakhir: hapus user
    aws iam delete-user --user-name "$user" && echo "âœ… User $user dihapus"
done

echo "Selesai menghapus semua user yang tidak dikecualikan."

